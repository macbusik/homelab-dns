---
- name: Create directory structure
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - "{{ install_path }}"
    - "{{ install_path }}/etc-pihole"
    - "{{ install_path }}/dnsmasq.d"

- name: Deploy Wildcard DNS configuration
  template:
    src: 99-wildcard.conf.j2
    dest: "{{ install_path }}/dnsmasq.d/99-wildcard.conf"
  notify: Restart Pihole

- name: Deploy Docker Compose
  template:
    src: docker-compose.yml.j2
    dest: "{{ install_path }}/docker-compose.yml"
  register: compose_file  

- name: Start containers (Docker Compose)
  community.docker.docker_compose_v2:
    project_src: "{{ install_path }}"
    state: present
    pull: always
    recreate: "{{ 'always' if compose_file.changed else 'auto' }}"
  notify: Restart Pihole
- name: Wait for DNS resolver to start
  pause:
    seconds: 5

- name: Test DNS response for .domek domain (inside container)
  command: "docker exec pihole dig +short @127.0.0.1 whoami.{{ root_domain }}"
  register: dns_test
  changed_when: false
  retries: 5
  delay: 3
  until: dns_test.stdout != ""

- name: Validate DNS result
  assert:
    that:
      - dns_test.stdout == server_ip
    fail_msg: "ERROR: DNS returned '{{ dns_test.stdout }}' instead of expected '{{ server_ip }}'"
    success_msg: "SUCCESS: Domain whoami.{{ root_domain }} correctly points to {{ server_ip }}"

- name: Test HTTP availability through Traefik
  uri:
    url: "http://127.0.0.1"
    headers:
      Host: "whoami.{{ root_domain }}"
    return_content: no
    status_code: 200
  register: http_test
  ignore_errors: yes

- name: Service status summary
  debug:
    msg: "System ready! You can access http://whoami.{{ root_domain }}"
  when: http_test.status == 200